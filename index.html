<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dedicated Two-Person Chat</title>
    <!-- Load Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styling for a modern, sticky chat interface */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
        }
        .chat-container {
            max-width: 800px;
            margin: 0 auto;
            height: 100vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .message-box {
            max-width: 75%;
            border-radius: 20px;
            padding: 10px 15px;
            margin-bottom: 8px;
            word-wrap: break-word;
            box-shadow: 0 1px 1px rgba(0, 0, 0, 0.05);
        }
        /* Style for the chat area to enable sticky footer */
        #messages-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background-color: #ffffff;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- Header -->
        <header class="bg-indigo-600 text-white p-4 shadow-lg sticky top-0 z-10 rounded-b-xl">
            <h1 class="text-xl font-bold">Secret Duo Chat ðŸ’¬</h1>
            <p id="user-info" class="text-xs mt-1 opacity-75"></p>
        </header>

        <!-- Messages Container -->
        <div id="messages-container">
            <div id="loading-indicator" class="text-center p-4 text-indigo-500 font-semibold">
                Connecting to the server...
            </div>
        </div>

        <!-- Input Area (Sticky Footer) -->
        <footer class="bg-white p-4 border-t border-gray-200 sticky bottom-0">
            <div id="auth-check" class="text-center p-2 text-sm text-red-500 hidden">Authentication needed...</div>
            <div class="flex space-x-3">
                <input
                    type="text"
                    id="message-input"
                    placeholder="Type your message here..."
                    class="flex-grow p-3 border border-gray-300 rounded-full focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-inner"
                    autocomplete="off"
                    disabled
                />
                <button
                    id="send-button"
                    class="bg-indigo-500 text-white font-semibold py-3 px-6 rounded-full hover:bg-indigo-600 transition duration-200 shadow-md hover:shadow-lg disabled:bg-indigo-300"
                    disabled
                >
                    Send
                </button>
            </div>
        </footer>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Mandatory Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, addDoc, onSnapshot, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-chat-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = null;
        let isAuthReady = false;

        const messagesContainer = document.getElementById('messages-container');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const userInfo = document.getElementById('user-info');
        const loadingIndicator = document.getElementById('loading-indicator');

        // Helper to shorten the user ID for display
        const getShortUserId = (uid) => uid.substring(0, 6);

        // Utility to scroll to the bottom of the chat
        const scrollToBottom = () => {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        };

        // --- Core Firebase Initialization and Authentication ---

        const initializeFirebase = async () => {
            if (!firebaseConfig) {
                console.error("Firebase configuration is missing.");
                userInfo.textContent = "Error: Firebase config not found.";
                loadingIndicator.textContent = "Failed to load chat.";
                return;
            }

            try {
                // Set Firestore log level for debugging
                setLogLevel('Debug');
                
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Try to sign in with the provided token, otherwise sign in anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Error initializing Firebase or signing in:", error);
                userInfo.textContent = "Authentication Error.";
            }
        };

        // --- Rendering Logic ---

        const renderMessage = (doc, currentUserId) => {
            const data = doc.data();
            const isMe = data.userId === currentUserId;
            const shortId = getShortUserId(data.userId);
            const time = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '...';

            // Determine colors and alignment
            const alignment = isMe ? 'self-end' : 'self-start';
            const bgColor = isMe ? 'bg-indigo-500 text-white' : 'bg-gray-200 text-gray-800';
            const nameColor = isMe ? 'text-indigo-700' : 'text-gray-500';

            const messageDiv = document.createElement('div');
            messageDiv.className = `message-box ${alignment} ${bgColor}`;
            
            const senderSpan = document.createElement('span');
            senderSpan.className = `text-xs font-semibold ${nameColor} mb-1 block ${isMe ? 'text-right' : 'text-left'}`;
            senderSpan.textContent = isMe ? 'You' : shortId;

            const textP = document.createElement('p');
            textP.className = 'text-sm';
            textP.textContent = data.message;

            const timeSpan = document.createElement('span');
            timeSpan.className = `text-xs mt-1 opacity-80 block ${isMe ? 'text-right' : 'text-left'}`;
            timeSpan.textContent = time;
            
            messageDiv.appendChild(senderSpan);
            messageDiv.appendChild(textP);
            messageDiv.appendChild(timeSpan);

            return messageDiv;
        };

        // --- Real-time Data Listener ---

        const startChatListener = (db, currentUserId) => {
            // Define the specific chat path. This fixed path ensures both of the 'two' people
            // using this instance share the same persistent conversation.
            const chatCollectionPath = `artifacts/${appId}/public/data/two_person_chats/general-chat-room/messages`;
            const chatRef = collection(db, chatCollectionPath);
            
            // Query for messages, ordered by timestamp
            const q = query(chatRef, orderBy("timestamp", "asc"));

            console.log(`Listening to chat at: ${chatCollectionPath}`);
            
            // Start the real-time listener
            return onSnapshot(q, (snapshot) => {
                let shouldScroll = false;
                
                // Check if the user is currently at the bottom of the chat
                if (messagesContainer.scrollHeight - messagesContainer.clientHeight <= messagesContainer.scrollTop + 50) {
                    shouldScroll = true;
                }

                // Remove loading indicator on first data load
                if(loadingIndicator) loadingIndicator.remove();
                
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        // Only process added documents (new messages)
                        const newMessage = renderMessage(change.doc, currentUserId);
                        messagesContainer.appendChild(newMessage);
                    }
                });

                // Scroll to bottom only if it was already near the bottom
                if (shouldScroll) {
                    scrollToBottom();
                }
            }, (error) => {
                console.error("Error listening to messages:", error);
                messagesContainer.innerHTML = `<div class="text-center p-4 text-red-600">Error loading messages: ${error.message}</div>`;
            });
        };

        // --- Sending Message Logic ---

        const sendMessage = async () => {
            const message = messageInput.value.trim();
            if (!message || !db || !userId) return;

            // Define the specific chat path for writing
            const chatCollectionPath = `artifacts/${appId}/public/data/two_person_chats/general-chat-room/messages`;
            const chatRef = collection(db, chatCollectionPath);

            const messagePayload = {
                userId: userId,
                message: message,
                timestamp: serverTimestamp() // Use server timestamp for accurate ordering
            };

            try {
                // Add the new message to the collection
                await addDoc(chatRef, messagePayload);
                messageInput.value = ''; // Clear the input
                scrollToBottom(); // Optimistically scroll to bottom
            } catch (error) {
                console.error("Error sending message:", error);
                // Simple error display
                const errorDiv = document.createElement('div');
                errorDiv.className = 'message-box bg-red-100 text-red-700 self-center';
                errorDiv.textContent = 'Failed to send message.';
                messagesContainer.appendChild(errorDiv);
            }
        };

        // --- Event Handlers ---

        sendButton.addEventListener('click', sendMessage);
        
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // --- Main Execution ---

        window.onload = async () => {
            await initializeFirebase();

            // Listen for Auth State Changes
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // User is signed in.
                    userId = user.uid;
                    isAuthReady = true;

                    // Update UI elements
                    userInfo.innerHTML = `Your ID: <span class="font-mono text-sm bg-indigo-700 p-1 rounded-md">${userId}</span><br>
                                          <span class="text-xs">Share your full ID with your partner so they know who you are.</span>`;
                    
                    messageInput.disabled = false;
                    sendButton.disabled = false;
                    
                    // Start the real-time listener only once the user is authenticated
                    startChatListener(db, userId);
                    
                } else {
                    // User is signed out.
                    userId = null;
                    isAuthReady = false;
                    userInfo.textContent = "Not connected. Please refresh.";
                    messageInput.disabled = true;
                    sendButton.disabled = true;
                    loadingIndicator.textContent = "Authentication failed.";
                }
            });
        };

    </script>
</body>
</html>
